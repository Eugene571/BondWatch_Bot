# bonds_get.moex_lookup.py

import httpx
import logging
from datetime import datetime
from typing import List, Optional


async def get_bondization_data_from_moex(isin: str) -> dict:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É–ø–æ–Ω–∞—Ö –∏ –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è—Ö (–≤–∫–ª—é—á–∞—è –ø–æ–≥–∞—à–µ–Ω–∏–µ) –ø–æ ISIN —Å MOEX.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å:
    {
        "isin": str,
        "coupons": List[dict],
        "amortizations": List[dict],
        "maturity_date": Optional[date]
    }
    """
    url = f"https://iss.moex.com/iss/securities/{isin}/bondization.json"
    logging.info(f"üîÑ –ó–∞–ø—Ä–æ—Å bondization.json –∫ MOEX –¥–ª—è ISIN {isin}: {url}")

    try:
        async with httpx.AsyncClient() as client:
            response = await client.get(url)
            response.raise_for_status()
            data = response.json()
            logging.info(f"üì¶ –û—Ç–≤–µ—Ç –æ—Ç MOEX –¥–ª—è {isin} —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")

        result = {
            "isin": isin,
            "coupons": [],
            "amortizations": [],
            "maturity_date": None
        }

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—É–ø–æ–Ω–æ–≤
        coupons_meta = data.get("coupons", {}).get("columns", [])
        coupons_data = data.get("coupons", {}).get("data", [])

        try:
            idx_coupondate = coupons_meta.index("coupondate")
            idx_value = coupons_meta.index("value")
            idx_percent = coupons_meta.index("valueprc")
        except ValueError as e:
            logging.warning(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∫—É–ø–æ–Ω–æ–≤ –¥–ª—è {isin}: {e}")
            idx_coupondate = idx_value = idx_percent = -1

        for row in coupons_data:
            if idx_coupondate == -1:
                break
            coupon_date = row[idx_coupondate]
            if not coupon_date:
                continue
            result["coupons"].append({
                "couponDate": str(coupon_date),
                "couponValue": row[idx_value] or 0,
                "couponPercent": row[idx_percent] or 0,
                "type": "COUPON"
            })

        logging.info(f"üìà –ù–∞–π–¥–µ–Ω–æ {len(result['coupons'])} –∫—É–ø–æ–Ω–æ–≤ –¥–ª—è {isin}")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–π –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ maturity_date
        amort_meta = data.get("amortizations", {}).get("columns", [])
        amort_data = data.get("amortizations", {}).get("data", [])

        try:
            idx_source = amort_meta.index("data_source")
            idx_amortdate = amort_meta.index("amortdate")
            idx_value = amort_meta.index("value")
        except ValueError as e:
            logging.warning(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–π –¥–ª—è {isin}: {e}")
            idx_amortdate = idx_value = -1

        maturity_candidate_dates = []

        for row in amort_data:
            if idx_amortdate == -1:
                break
            amort_date = row[idx_amortdate]
            if not amort_date:
                continue
            result["amortizations"].append({
                "amortDate": str(amort_date),
                "amortValue": row[idx_value] or 0,
                "dataSource": row[idx_source] or "",
                "type": "AMORTIZATION"
            })
            maturity_candidate_dates.append(amort_date)

        logging.info(f"üèÅ –ù–∞–π–¥–µ–Ω–æ {len(result['amortizations'])} –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–π –¥–ª—è {isin}")

        if maturity_candidate_dates:
            try:
                parsed_dates = [
                    datetime.strptime(str(d), "%Y-%m-%d").date()
                    for d in maturity_candidate_dates
                ]
                result["maturity_date"] = max(parsed_dates)
                logging.info(f"üéØ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –¥–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è: {result['maturity_date']}")
            except Exception as e:
                logging.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞—Ç –ø–æ–≥–∞—à–µ–Ω–∏—è: {e}")
        return result

    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ bondization.json –¥–ª—è {isin}: {e}")
        return {
            "isin": isin,
            "coupons": [],
            "amortizations": [],
            "maturity_date": None
        }
