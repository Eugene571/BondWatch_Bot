# BondWatch Bot

BondWatch — это Telegram-бот, предназначенный для отслеживания и уведомления пользователей о событиях, связанных с российскими облигациями, таких как выплаты купонов, погашения, амортизации и оферты. Бот интегрируется с API Московской биржи (MOEX) для получения данных об облигациях и использует YooKassa для обработки платежей по подписке. Поддерживаются как бесплатный, так и платные тарифы с разными лимитами на количество отслеживаемых облигаций.

## Возможности

- **Отслеживание облигаций**: Добавление, удаление или изменение количества отслеживаемых облигаций по ISIN-кодам.
- **Уведомления о событиях**: Ежедневные уведомления в 12:00 по МСК о:
  - Выплатах купонов (за 1 день).
  - Амортизациях (за 1 день).
  - Погашениях (за 7 дней).
  - Офертах (за 14 дней).
- **Тарифные планы**:
  - Бесплатный: отслеживание до 1 облигации.
  - Basic: до 10 облигаций (390 ₽/мес).
  - Optimal: до 20 облигаций (590 ₽/мес).
  - Pro: неограниченное количество облигаций (990 ₽/мес).
- **Интеграция с платежами**: Безопасные платежи через YooKassa с поддержкой автопродления.
- **Система поддержки**: Пользователи могут отправлять текстовые сообщения или медиа (фото/документы) в поддержку.
- **Ночная синхронизация**: Автоматическое обновление данных об облигациях (купоны, амортизации, оферты, погашения) с MOEX.
- **Управление базой данных**: Использует PostgreSQL с SQLAlchemy для эффективного хранения и извлечения данных.

## Технологический стек

- **Python**: Основной язык программирования.
- **python-telegram-bot**: Для функциональности Telegram-бота.
- **SQLAlchemy**: ORM для работы с базой данных PostgreSQL.
- **aiohttp**: Асинхронные HTTP-запросы к API MOEX.
- **YooKassa**: Обработка платежей по подписке.
- **APScheduler**: Планирование ежедневных задач (уведомления и синхронизация данных).
- **Логирование**: Полное логирование в файл (`bot.log`) и консоль.

## Использование

1. **Запуск бота**:
   - Отправьте команду `/start`, чтобы зарегистрироваться и инициализировать пользователя в базе данных.
   - Бесплатный тариф автоматически назначается, позволяя отслеживать одну облигацию.

2. **Доступные команды**:
   - `/help`: Показать список доступных команд и функционал.
   - `/list`: Просмотреть все отслеживаемые облигации.
   - `/events`: Проверить ближайшие события по облигациям.
   - `/add`: Добавить облигацию, указав ISIN и количество.
   - `/remove`: Удалить облигацию по ISIN.
   - `/change_quantity`: Изменить количество отслеживаемых облигаций.
   - `/upgrade`: Просмотреть и приобрести тарифные планы.
   - `/support`: Отправить сообщение и/или файлы в поддержку.
   - `/disable_autorenew`: Отключить автопродление подписки.

3. **Уведомления**:
   - Отправляются ежедневно в 12:00 по МСК о предстоящих событиях.
   - Уведомления логируются и сохраняются в БД для предотвращения дублирования.

4. **Ночная синхронизация**:
   - Выполняется ежедневно в 00:05 для обновления данных об облигациях с MOEX.
   - Обеспечивает актуальность дат купонов, амортизаций, оферт и погашений.

## Структура проекта

```
bondwatch/
├── bot/
│   ├── handlers.py           # Обработчики команд и диалогов Telegram
│   └── subscription_utils.py # Проверка лимитов подписки и обновление статуса
├── bonds_get/
│   ├── bond_update.py        # Обновление данных об облигациях (купоны, амортизации и т.д.)
│   ├── bond_utils.py        # Утилита для проверки, является ли ISIN облигацией
│   ├── moex_lookup.py       # Получение данных об облигациях с API MOEX
│   └── nightly_sync.py      # Ночная синхронизация данных об облигациях
├── database/
│   ├── db.py                # Модели базы данных и настройка подключения
│   └── moex_name_lookup.py  # Получение названий облигаций с MOEX
├── config.py                # Конфигурация (например, токен Telegram)
├── main.py                  # Основное приложение бота
├── manual_sync.py           # Скрипт для ручной синхронизации данных
├── notification.py          # Логика уведомлений о событиях по облигациям
├── requirements.txt         # Зависимости проекта
└── .env                    # Переменные окружения (не отслеживается)
```

## Схема базы данных

- **Users**: Хранит данные пользователей Telegram (`tg_id`, `full_name`).
- **Subscriptions**: Управляет данными подписки (`plan`, `is_subscribed`, `subscription_end` и т.д.).
- **BondsDatabase**: Хранит данные об облигациях (`isin`, `name`, `next_coupon_date`, `maturity_date` и т.д.).
- **UserTracking**: Отслеживает облигации для каждого пользователя с указанием количества (`user_id`, `isin`, `quantity`).
- **UserNotifications**: Логирует отправленные уведомления для предотвращения дублирования (`user_id`, `bond_isin`, `event_type`, `event_date`).

## Внесение изменений

1. Сделайте форк репозитория.
2. Создайте ветку для новой функции (`git checkout -b feature/ВашаФункция`).
3. Зафиксируйте изменения (`git commit -m "Добавлена ВашаФункция"`).
4. Отправьте ветку в репозиторий (`git push origin feature/ВашаФункция`).
5. Создайте запрос на включение изменений (pull request).

